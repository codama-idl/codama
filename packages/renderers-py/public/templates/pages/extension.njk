{% extends "layout.njk" %}

{% block main %}

"""Extensions to the Borsh spec for Solana-specific types."""
from dataclasses import asdict
from keyword import kwlist
from typing import Any, Dict, Type, TypeVar, cast

from borsh_construct import U32, CStruct
from construct import (
    Adapter,
    Bytes,
    Construct,
    Container,
    IfThenElse,
    Padding,
    Renamed,
    Switch,
    GreedyBytes
)
from construct import Int64ul as U64
from solders import pubkey

U64Bytes = Prefixed(U64, GreedyBytes)

class _String64(Adapter):
    def __init__(self) -> None:
        super().__init__(U64Bytes)  # type: ignore

    def _decode(self, obj: bytes, context, path) -> str:
        return obj.decode("utf8")

    def _encode(self, obj: str, context, path) -> bytes:
        return bytes(obj, "utf8")
String64=_String64()

class EnumForCodegenU32(Adapter):
    _index_key = "index"
    _value_key = "value"

    def __init__(self, *variants: "Renamed[CStruct, CStruct]") -> None:
        """Init enum."""
        switch_cases: dict[int, "Renamed[CStruct, CStruct]"] = {}
        variant_name_to_index: dict[str, int] = {}
        index_to_variant_name: dict[int, str] = {}
        for idx, parser in enumerate(variants):
            switch_cases[idx] = parser
            name = cast(str, parser.name)
            variant_name_to_index[name] = idx
            index_to_variant_name[idx] = name
        enum_struct = CStruct(
            self._index_key / U32,
            self._value_key
            / Switch(lambda this: this.index, cast(dict[int, Construct], switch_cases)),
        )
        super().__init__(enum_struct)  # type: ignore
        self.variant_name_to_index = variant_name_to_index
        self.index_to_variant_name = index_to_variant_name

    def _decode(self, obj: CStruct, context, path) -> dict[str, Any]:
        index = obj.index
        variant_name = self.index_to_variant_name[index]
        return {variant_name: obj.value}

    def _encode(self, obj: dict[str, Any], context, path) -> dict[str, Any]:
        variant_name = list(obj.keys())[0]
        index = self.variant_name_to_index[variant_name]
        return {self._index_key: index, self._value_key: obj[variant_name]}
{% endblock %}
